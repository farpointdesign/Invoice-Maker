<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1e90ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Invoice App">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f6f8;
      color: #333;
    }
    .form-block {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }
    .form-block label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
      font-size: 14px;
    }
    .form-block input,
    .form-block textarea {
      margin-top: 5px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .form-buttons {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }
    .invoice-section {
      display: none;
      max-width: 800px;
      margin: auto;
      background-color: #fff;
      padding: 25px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border: 1px solid #c0d4ef;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: 10px;
      margin-bottom: 20px;
      border-bottom: 3px solid #1e90ff;
    }
    .header-title {
      font-size: 36px;
      font-weight: bold;
      color: #1e90ff;
      letter-spacing: 1px;
    }
    .header-address {
      text-align: right;
      font-size: 14px;
      line-height: 1.4;
    }
    .section {
      margin-bottom: 15px;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: left;
    }
    th {
      background-color: #e2efff;
    }
    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-top: 30px;
    }
    .footer-row p {
      margin: 0;
      font-size: 13px;
      line-height: 1.4;
    }
    #venmoQrCode canvas {
      width: 80px !important;
      height: 80px !important;
    }
    button {
      padding: 10px 15px;
      font-weight: bold;
      background-color: #1e90ff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0078d4;
    }
    @media print {
      .form-block {
        display: none;
      }
      .invoice-section {
        display: block !important;
      }
      body {
        background: white;
        color: black;
      }
      th {
        background-color: #ddd !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
function loadInvoice(input) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      document.getElementById('senderName').value = data.senderName || '';
      document.getElementById('senderAddress').value = data.senderAddress || '';
      document.getElementById('billToInput').value = data.billTo || '';
      document.getElementById('invoiceNo').value = data.invoiceNo || '';
      document.getElementById('issueDate').value = data.issueDate || '';
      document.getElementById('dueDate').value = data.dueDate || '';
      document.getElementById('description').value = data.description || '';
      document.getElementById('taskList').value = (data.taskList || []).join('\n');
      document.getElementById('totalHours').value = data.totalHours || '';
      document.getElementById('hourlyRate').value = data.hourlyRate || '';
      document.getElementById('materialsCostInput').value = data.materialsCost || '';
      document.getElementById('amountPaid').value = data.amountPaid || '';
      updateInvoiceOnly();
    } catch (err) {
      alert("Invalid JSON file");
    }
  };
  reader.readAsText(file);
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="form-block">
    <label>Sender Name: <input id="senderName" value="Jabrial Gentry"></label>
    <label>Sender Address: <textarea id="senderAddress">PO Box 823
Heber City, UT 84032</textarea></label>
    <label>Bill To: <textarea id="billToInput">Client Name
123 Client St.
City, ST 00000</textarea></label>
    <label>Invoice #: <input id="invoiceNo" value="001"></label>
    <label>Issue Date: <input id="issueDate" type="date"></label>
    <label>Due Date: <input id="dueDate" type="date"></label>
    <label>Description: <input id="description" value="Bathroom Remodel"></label>
    <label style="grid-column: 1 / -1">Tasks (format: Task - Hours per line): <textarea id="taskList">Demo tile - 4
Install tile - 6</textarea></label>
    <label>Total Hours: <input id="totalHours" value="10"></label>
    <label>Hourly Rate: <input id="hourlyRate" value="75"></label>
    <label>Materials Cost: <input id="materialsCostInput" value="250"></label>
    <label>Amount Paid: <input id="amountPaid" value="0"></label>
    <div class="form-buttons">
  <button onclick="updateInvoiceOnly()">Generate Invoice</button>
  <button onclick="saveAndPrintInvoice()">Save and Print</button>
  <label style="display: flex; align-items: center; cursor: pointer;">
  <input type="file" accept=".json" style="display: none" onchange="loadInvoice(this)">
  <span style="padding: 10px 15px; background-color: #1e90ff; color: white; border-radius: 5px;">Load Invoice File</span>
</label>
</div>
  </div>

  <div class="invoice-section">
    <div class="header">
      <div class="header-title">INVOICE</div>
      <div class="header-address">
        <div id="senderNameText">Jabrial Gentry</div>
        <div id="senderAddressText">PO Box 823<br>Heber City, UT 84032</div>
      </div>
    </div>
    <div class="section"><strong>Bill To:</strong><br><div id="billTo"></div></div>
    <div class="section"><strong>Invoice #:</strong> <span id="invoiceNumber"></span></div>
    <div class="section"><strong>Issue Date:</strong> <span id="issueDateText"></span> | <strong>Due Date:</strong> <span id="dueDateText"></span></div>
    <div class="section"><strong>Description:</strong> <span id="descriptionText"></span></div>
    <div class="section">
      <table>
        <thead><tr><th>Task</th><th>Hours</th></tr></thead>
        <tbody id="taskTable"></tbody>
        <tfoot>
          <tr><td colspan="2" style="border: none;"></td></tr>
          <tr><td><strong>Total Hours</strong></td><td id="totalHoursText" style="text-align:right"></td></tr>
          <tr><td><strong>Hourly Rate</strong></td><td id="hourlyRateText" style="text-align:right"></td></tr>
          <tr><td colspan="2" style="border: none;"></td></tr>
          <tr><td><strong>Labor Total</strong></td><td id="laborTotal" style="text-align:right"></td></tr>
          <tr><td><strong>Materials</strong></td><td id="materialsCost" style="text-align:right"></td></tr>
          <tr><td colspan="2" style="border: none;"></td></tr>
          <tr><td><strong>Total</strong></td><td id="totalCost" style="text-align:right"></td></tr>
          <tr><td><strong>Paid</strong></td><td id="paid" style="text-align:right"></td></tr>
          <tr><td><strong>Amount Due</strong></td><td id="due" style="text-align:right"></td></tr>
        </tfoot>
      </table>
    </div>
    <div class="footer-row">
      <div>
        <p>Make checks payable to:</p>
        <p id="footerName">Jabrial Gentry</p>
        <p id="footerAddress">PO Box 823<br>Heber City, UT 84032</p>
      </div>
      <div id="venmoQrCode"></div>
    </div>
  </div>

  <script>
    new QRCode(document.getElementById("venmoQrCode"), {
      text: "https://venmo.com/u/CrawdadthePinchy",
      width: 80,
      height: 80
    });

    function updateInvoiceOnly() {
      const name = document.getElementById('senderName').value;
      const address = document.getElementById('senderAddress').value;
      const billTo = document.getElementById('billToInput').value.replace(/\n/g, '<br>');
      const invoiceNo = document.getElementById('invoiceNo').value;
      const issueDate = new Date(document.getElementById('issueDate').value).toLocaleDateString();
      const dueDate = new Date(document.getElementById('dueDate').value).toLocaleDateString();
      const description = document.getElementById('description').value;
      const taskList = document.getElementById('taskList').value.trim().split('\n');
      const totalHours = parseFloat(document.getElementById('totalHours').value);
      const hourlyRate = parseFloat(document.getElementById('hourlyRate').value);
      const materialsCost = parseFloat(document.getElementById('materialsCostInput').value);
      const amountPaid = parseFloat(document.getElementById('amountPaid').value);

      const laborTotal = (totalHours * hourlyRate).toFixed(2);
      const totalCost = (parseFloat(laborTotal) + materialsCost).toFixed(2);
      const totalDue = (totalCost - amountPaid).toFixed(2);

      document.getElementById('senderNameText').innerText = name;
      document.getElementById('senderAddressText').innerHTML = address.replace(/\n/g, '<br>');
      document.getElementById('billTo').innerHTML = billTo;
      document.getElementById('invoiceNumber').innerText = invoiceNo;
      document.getElementById('issueDateText').innerText = issueDate;
      document.getElementById('dueDateText').innerText = dueDate;
      document.getElementById('descriptionText').innerText = description;

      const tbody = document.getElementById('taskTable');
      tbody.innerHTML = '';
      taskList.forEach(task => {
        const [desc, hours] = task.split(' - ');
        tbody.innerHTML += `<tr><td>${desc}</td><td style="text-align:right">${hours}</td></tr>`;
      });

      document.getElementById('totalHoursText').innerText = totalHours;
      document.getElementById('hourlyRateText').innerText = `$${hourlyRate.toFixed(2)}`;
      document.getElementById('laborTotal').innerText = `$${laborTotal}`;
      document.getElementById('materialsCost').innerText = `$${materialsCost.toFixed(2)}`;
      document.getElementById('totalCost').innerText = `$${totalCost}`;
      document.getElementById('paid').innerText = `- $${amountPaid.toFixed(2)}`;
      document.getElementById('due').innerText = `$${totalDue}`;
      document.getElementById('footerName').innerText = name;
      document.getElementById('footerAddress').innerHTML = address.replace(/\n/g, '<br>');

      document.querySelector('.invoice-section').style.display = 'block';
    }
	
	function saveAndPrintInvoice() {
  updateInvoiceOnly(); // updates the invoice preview with form data

  const invoiceData = {
    senderName: document.getElementById('senderName').value,
    senderAddress: document.getElementById('senderAddress').value,
    billTo: document.getElementById('billToInput').value,
    invoiceNo: document.getElementById('invoiceNo').value,
    issueDate: document.getElementById('issueDate').value,
    dueDate: document.getElementById('dueDate').value,
    description: document.getElementById('description').value,
    taskList: document.getElementById('taskList').value.trim().split('\n'),
    totalHours: document.getElementById('totalHours').value,
    hourlyRate: document.getElementById('hourlyRate').value,
    materialsCost: document.getElementById('materialsCostInput').value,
    amountPaid: document.getElementById('amountPaid').value
  };

  const fileName = `${invoiceData.invoiceNo}_${invoiceData.billTo.split('\n')[0].replace(/\s+/g, '_')}_${invoiceData.issueDate || 'invoice'}.json`;
  const blob = new Blob([JSON.stringify(invoiceData, null, 2)], { type: 'application/json' });
  const blobUrl = URL.createObjectURL(blob);

  const fakeLink = document.createElement('a');
  fakeLink.href = blobUrl;
  fakeLink.setAttribute('download', fileName);
  fakeLink.style.display = 'none';
  document.body.appendChild(fakeLink);
  fakeLink.click();

  setTimeout(() => {
    URL.revokeObjectURL(blobUrl);
    document.body.removeChild(fakeLink);
    const element = document.querySelector('.invoice-section');
    html2canvas(element).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jspdf.jsPDF();
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      pdf.save(fileName.replace('.json', '.pdf'));
    });
  }, 100);
}
  </script>
  
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log('Service worker registered.', reg))
      .catch(err => console.error('Service worker registration failed:', err));
  }
</script>
</body>
</html>
